{% extends "base.html" %}
{% block title %}Dashboard{% endblock %}

{% block content %}
    <div class="dashboard-header">
        <h2>Welcome back, {{ user.name }}! 👋</h2>
    </div>

    <div class=" card-time">
        <h3>Time Left</h3>
        <h3 id="timer">00:00:00</h3>
    </div>

    <div class="user-info">
        <p>Referral Code: <b>{{ current_user.referral_code }}</b></p>
        <p>Your XP: <b>{{ current_user.score }}</b></p>
    </div>



    <div class="card">
    <h3>Today's Mission</h3>
    <p class="task-text">{{ task.task_text }}</p>
    <button class="ai-btn" onclick="getSuggestion('{{ task.task_text }}', this)">
        💡 AI Suggest
    </button>
    <button id="simplify-task-btn">Simplify Task</button>
    <div class="simplified-task"></div>

    <div class="suggestion" style="margin-top:5px; color:#4CAF50;"></div>
</div>

    <button id="complete-task-btn">Complete Task ✅</button>
    <div class="task-feedback"></div>


    <div class="card">
        <h3>Connect with Someone New</h3>
        <p>Enter the referral code of the person you met:</p>
        <form action="{{ url_for('add_connection') }}" method="POST" class="connect-form">
            <input type="text" name="referral_code" placeholder="Enter Referral Code" required>
            <button type="submit" class="btn">Connect</button>
        </form>
    </div>
    
    <div class="card">
        <h3>Recent Connections</h3>
        {% if connections %}
            <ul class="connections-list">
                {% for friend in connections %}
                    <li>{{ friend.name }}</li>
                {% endfor %}
            </ul>
             <a href="{{ url_for('connections') }}" class="view-all">View all connections &rarr;</a>
        {% else %}
            <p>You haven't made any connections yet. Use your daily task to meet someone!</p>
        {% endif %}
    </div>

    <!----LeaderBoard-->
    
    <div class="card leaderboard-card">
    <h3>🏆 Leaderboard</h3>
    <ul class="leaderboard-list">
    {% for entry in leaderboard %}
      <li class="leaderboard-item rank{{ loop.index }}">
        <div class="rank-badge">{{ loop.index }}</div>
        <div class="leader-info">
          <span class="leader-name">{{ entry.name }}</span>
          <span class="leader-score">{{ entry.score }} pts</span>
        </div>
      </li>
    {% endfor %}
    </ul>
    </div>

<script>

    function getSuggestion(taskText, btn) {
    const card = btn.closest('.card');
    const suggestionDiv = card.querySelector('.suggestion');
    suggestionDiv.textContent = "Loading suggestion...";

    fetch("/ai_suggest", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ task: taskText })
    })
    .then(res => res.json())
    .then(data => {
        if (data.suggestion) {
            suggestionDiv.textContent = data.suggestion;
        } else if (data.error) {
            suggestionDiv.textContent = "Failed to get suggestion";
            console.error(data.error);
        }
    })
    .catch(err => {
        suggestionDiv.textContent = "Error fetching suggestion";
        console.error(err);
    });
}

document.getElementById("simplify-task-btn").addEventListener("click", async () => {
    const simplifiedDiv = document.querySelector(".simplified-task");
    simplifiedDiv.innerHTML = "Simplifying...";

    try {
        const response = await fetch("/simplify_task", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ task: {{ task.task_text|tojson }} })
        });

        const data = await response.json();

        if (data.task) {
            simplifiedDiv.innerHTML = "New Task: " + data.task;
        } else {
            simplifiedDiv.innerHTML = data.error || "Failed to simplify 😕";
        }
    } catch (err) {
        simplifiedDiv.innerHTML = "Failed to simplify 😕";
        console.error(err);
    }
});


</script>

    <script>
    const timerDisplay = document.getElementById("timer");

function getRemainingSecondsUntil2PM() {
    const now = new Date();
    const target = new Date();

    // Set target time to 2 PM today
    target.setHours(24, 0, 0, 0);

    // If it's already past 2 PM, set target to 2 PM tomorrow
    if (now >= target) {
        target.setDate(target.getDate() + 1);
    }

    // Calculate remaining seconds
    const diffInSeconds = Math.floor((target - now) / 1000);
    return diffInSeconds;
}

let remainingSeconds = getRemainingSecondsUntil2PM();

function updateTimer() {
    const hrs = String(Math.floor(remainingSeconds / 3600)).padStart(2, '0');
    const mins = String(Math.floor((remainingSeconds % 3600) / 60)).padStart(2, '0');
    const secs = String(remainingSeconds % 60).padStart(2, '0');

    timerDisplay.textContent = `${hrs}:${mins}:${secs}`;

    if (remainingSeconds <= 0) {
        clearInterval(timerInterval);
        timerDisplay.textContent = "00:00:00";
        return;
    }

    remainingSeconds--;
}

const timerInterval = setInterval(updateTimer, 1000);
updateTimer();


document.getElementById("complete-task-btn").addEventListener("click", async () => {
    const feedbackDiv = document.querySelector(".task-feedback");
    feedbackDiv.innerHTML = "Completing task...";

    try {
        const response = await fetch("/complete_task", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ task_id: {{ task.id }} })
        });

        const data = await response.json();

        if (data.new_score) {
            feedbackDiv.innerHTML = `🎉 Task completed! You earned ${data.xp_gained} XP. Total XP: ${data.new_score}`;
        } else {
            feedbackDiv.innerHTML = data.error || "Failed to complete task 😕";
        }
    } catch (err) {
        feedbackDiv.innerHTML = "Failed to complete task 😕";
        console.error(err);
    }
});
</script>

{% endblock %}