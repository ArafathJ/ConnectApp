{% extends "base.html" %}
{% block title %}Dashboard{% endblock %}

{% block content %}
    <div class="dashboard-header">
        <h2>Welcome back, {{ user.name }}! ðŸ‘‹</h2>
    </div>

    <div class="card">
    <h3>Today's Mission</h3>
    <p class="task-text">{{ task.task_text }}</p>
    <button class="ai-btn" onclick="getSuggestion('{{ task.task_text }}', this)">
        ðŸ’¡ AI Suggest
    </button>
    <button id="simplify-task-btn">Simplify Task</button>
    <div class="simplified-task"></div>

    <div class="suggestion" style="margin-top:5px; color:#4CAF50;"></div>
</div>

    <div class="card">
        <h3>Connect with Someone New</h3>
        <p>Enter the referral code of the person you met:</p>
        <form action="{{ url_for('add_connection') }}" method="POST" class="connect-form">
            <input type="text" name="referral_code" placeholder="Enter Referral Code" required>
            <button type="submit" class="btn">Connect</button>
        </form>
    </div>
    
    <div class="card">
        <h3>Recent Connections</h3>
        {% if connections %}
            <ul class="connections-list">
                {% for friend in connections %}
                    <li>{{ friend.name }}</li>
                {% endfor %}
            </ul>
             <a href="{{ url_for('connections') }}" class="view-all">View all connections &rarr;</a>
        {% else %}
            <p>You haven't made any connections yet. Use your daily task to meet someone!</p>
        {% endif %}
    </div>

<script>

    function getSuggestion(taskText, btn) {
    const card = btn.closest('.card');
    const suggestionDiv = card.querySelector('.suggestion');
    suggestionDiv.textContent = "Loading suggestion...";

    fetch("/ai_suggest", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ task: taskText })
    })
    .then(res => res.json())
    .then(data => {
        if (data.suggestion) {
            suggestionDiv.textContent = data.suggestion;
        } else if (data.error) {
            suggestionDiv.textContent = "Failed to get suggestion";
            console.error(data.error);
        }
    })
    .catch(err => {
        suggestionDiv.textContent = "Error fetching suggestion";
        console.error(err);
    });
}

document.getElementById("simplify-task-btn").addEventListener("click", async () => {
    const simplifiedDiv = document.querySelector(".simplified-task");
    simplifiedDiv.innerHTML = "Simplifying...";

    try {
        const response = await fetch("/simplify_task", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ task: {{ task.task_text|tojson }} })
        });

        const data = await response.json();

        if (data.task) {
            simplifiedDiv.innerHTML = "New Task: " + data.task;
        } else {
            simplifiedDiv.innerHTML = data.error || "Failed to simplify ðŸ˜•";
        }
    } catch (err) {
        simplifiedDiv.innerHTML = "Failed to simplify ðŸ˜•";
        console.error(err);
    }
});


</script>

    

{% endblock %}